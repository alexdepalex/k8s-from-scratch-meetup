#cloud-config

---
coreos:
  etcd2:
    name: "%H"
    advertise-client-urls: http://$public_ipv4:2379
    initial-advertise-peer-urls: http://$private_ipv4:2380
    initial-cluster: core-01=http://172.17.8.101:2380,core-02=http://172.17.8.102:2380,core-03=http://172.17.8.103:2380
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
    listen-peer-urls: http://$private_ipv4:2380,http://$private_ipv4:7001
  fleet:
    public-ip: "$public_ipv4"
  units:
  - name: etcd2.service
    command: start
  - name: fleet.service
    command: start
  - name: docker-tcp.socket
    command: start
    enable: true
    content: |
      [Unit]
      Description=Docker Socket for the API

      [Socket]
      ListenStream=2375
      Service=docker.service
      BindIPv6Only=both

      [Install]
      WantedBy=sockets.target
  - name: kube-kubelet.service
    enable: false
    content: |
      [Unit]
      Description=Kubernetes Kubelet
      Documentation=https://github.com/kubernetes/kubernetes
      Requires=docker.service
      After=docker.service
      Wants=kube-kubelet-master-configs.service
      After=kube-kubelet-master-configs.service

      [Service]
      ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
      ExecStart=/opt/bin/kubelet \
      --api-servers=http://172.17.8.101:8080 \
      --healthz-bind-address=0.0.0.0 \
      --config=/etc/kubernetes/manifests \
      --network-plugin=cni \
      --network-plugin-dir=/etc/cni/net.d \
      --allow-privileged=true
      Restart=always
      RestartSec=10
  - name: kube-proxy.service
    enable: false
    content: |
      [Unit]
      Description=Kubernetes Proxy
      Documentation=https://github.com/kubernetes/kubernetes

      [Service]
      ExecStart=/opt/bin/kube-proxy \
      --master=http://172.17.8.101:8080 \
      --logtostderr=true
      Restart=always
      RestartSec=10
  - name: kube-kubelet-master-configs.service
    command: start
    content: |
      [Unit]
      Description=Activate Kubernetes Master coponents
      ConditionHost=core-01
      [Service]
      ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
      ExecStart=/bin/cp /etc/kubernetes/configs/kube-apiserver.yml /etc/kubernetes/configs/kube-scheduler.yml /etc/kubernetes/configs/kube-controller-manager.yml /etc/kubernetes/manifests
      RemainAfterExit=yes
      Type=oneshot
write_files:
- path: "/etc/kubernetes/configs/kube-apiserver.yml"
  permissions: '0755'
  content: |
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: kube-apiserver
      namespace: kube-system
    spec:
      hostNetwork: true
      containers:
      - name: kube-apiserver
        image: gcr.io/google_containers/hyperkube:v1.4.0
        command:
        - /hyperkube
        - apiserver
        - --bind-address=$private_ipv4
        - --etcd-servers=http://localhost:2379
        - --allow-privileged=true
        - --insecure-bind-address=0.0.0.0
        - --service-cluster-ip-range=10.0.16.0/22
        - --service-node-port-range=25000-32767
        - --secure-port=8084
        - --advertise-address=$private_ipv4
        - --admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,ServiceAccount,SecurityContextDeny,ResourceQuota
        - --service-account-key-file=/etc/kubernetes/ssl/serviceaccount.key
        ports:
        - containerPort: 8084
          hostPort: 8084
          name: https
        - containerPort: 8080
          hostPort: 8080
          name: local
        volumeMounts:
        - mountPath: /etc/kubernetes/ssl
          name: ssl-certs-kubernetes
          readOnly: true
      volumes:
      - name: ssl-certs-kubernetes
        hostPath:
          path: /etc/kubernetes/ssl
- path: "/etc/kubernetes/configs/kube-controller-manager.yml"
  permissions: '0755'
  content: |
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: kube-controller-manager
      namespace: kube-system
    spec:
      hostNetwork: true
      containers:
      - name: kube-controller-manager
        image: gcr.io/google_containers/hyperkube:v1.4.0
        command:
        - /hyperkube
        - controller-manager
        - --master=http://$private_ipv4:8080
        - --service-account-private-key-file=/etc/kubernetes/ssl/serviceaccount.key
        livenessProbe:
          httpGet:
            host: 127.0.0.1
            path: /healthz
            port: 10252
          initialDelaySeconds: 15
          timeoutSeconds: 1
        volumeMounts:
        - mountPath: /etc/kubernetes/ssl
          name: ssl-certs-kubernetes
          readOnly: true
      volumes:
      - name: ssl-certs-kubernetes
        hostPath:
          path: /etc/kubernetes/ssl
- path: "/etc/kubernetes/configs/kube-scheduler.yml"
  permissions: '0755'
  content: |
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: kube-scheduler
      namespace: kube-system
    spec:
      hostNetwork: true
      containers:
      - name: kube-scheduler
        image: gcr.io/google_containers/hyperkube:v1.4.0
        command:
        - /hyperkube
        - scheduler
        - --master=http://$private_ipv4:8080
        livenessProbe:
          httpGet:
            host: 127.0.0.1
            path: /healthz
            port: 10251
          initialDelaySeconds: 15
          timeoutSeconds: 1
- path: "/etc/kubernetes/ssl/serviceaccount.key"
  permissions: '0700'
  content: |
    -----BEGIN RSA PRIVATE KEY-----
    MIIEowIBAAKCAQEAthvNlC0M13tL+196joGyyRkc9Z1TJyM1HA0x1ClMXLDNXYth
    lnlbW5p/BHPhBiEIRXoQia05pWUWhmRAHfsHL/kzZlWrRlsmoJHkBKw28b8XSZ9p
    EMvqFTdRsAJxrG69FoMvoAdyu3Jqv3BSyOBcI8MBtoApB6Kg0wj3l6boqI0D1Qc8
    2pzcoh83txZFPw/LCR2dT2ATNyrh3Tt4cQlzJ6EWa75mWeMiC/xxEqJgi12duIWi
    KCR3XhkXB1vNPBsiFq30RdvzvPeDfeWhjK3CTpeFRTnHS8xmSKLrreaahe1ifQAR
    +GNGbKqAOD3oT43u3loFGNVBnSqcQWSThNe3JQIDAQABAoIBAFGvlP5zWsBJcSK3
    iEzmBqFH34KY6FS06TzE+mX1hGhLckMUo1iQ5Rbo7TK9G+HY7VHk2Ag5qJL1Di6I
    R25rTKULPjAYG3S6rE/4QPSLnzW/Bp4ioElFfqG3p6+w2PaE0dKIU9OPo7pLL3Dh
    3HB4mzv7XAhV4pGnNEaVTiI7Xz9DCAhhx607tnbzl5E1U9DZS1TGfwMld8LRgQc/
    RZkh4Sgb7QL+Ze/1TRSD5baDxaH5TaPHKxqBGyRteoLjBUf0wQifMGkvtOG0oVrC
    CEnOFnWRuv7v8zNFWFz+EPMg7hVA0cayXopA9m5j2NBFSjd/NVT1bvCa1SXHkIJ8
    +Y6QM90CgYEA3CwuAuxZFTKfq5ZwW/cDvsetlCYeNApsxcBCrv3v3qoC+BbJk2nU
    HK8Ti0/QtLJgVBt3TLHfxndiKWLhf9HUYO05LAY3GiFQDC/8d6TwOnFXJEfck7TJ
    IgbIBIRF+J29WaNpd6Sf328xPF4Rkl/S3OfzW/DDneFbFzcuU6wk73cCgYEA0736
    B7xNK1dFY2rp/AC98OA6Q3DRixWRPKZaPCTgjhuI18b/Y0jbGe8HGJ1DqZ7YGy4E
    aEZhEOOS+wzaBfsG0Vj3lOjURDrQB3NctLoPyaZ5Yz1GeLKWYV3L6FzXquI7YZ5c
    hBShxfgiDsGbIMhLqCDSUIW6u3Dyf6qW+0ocDUMCgYEA24jF3C5UaRmQMiSQJnL3
    7gvmHRmg9h0K9mdNVnVn7yqwSTVXi0BzuqIrp7ZPEU3nVRYJ75RQ3/D8FO4+kRfl
    XzxKzIXp/YkH6w8R+y6gRnXrAQcSfsk94ErIuBA4QLzwJ+gT6rNgogaaHmphtQUN
    GS3C74LzWoJxNIXWEKJONeMCgYBNZUyGFVMTu4OWclbykQbci+lgC1Xcg9ahl6C2
    CTi3WOMtFAT3soK7uP4cBifcUT5muOxNfSQvuy9Xanwq4XW9gcqFeJFWGzU88/L3
    8Gai66HFH3mp1oVXM6S722vNf4H7DZp9gNkc9rTkNepREkVtQAn/+tGlgARzm9Qy
    KAWW5wKBgFCbNfV3R1oy1hAkwTatXBkRARs6sWS1dvOyUW35k4+ekVOesCpyjzaW
    1F1M8MEzLc2K5+BdRsdUoko1kxC9Pm+QloX2M9tQrtsX+a+5p2pG1oh2x7Q86m+Y
    7HaBgEE/eevYIuy6l+kLg1elGyofBDzntnAxjOSXNg7wm7mWCFhf
    -----END RSA PRIVATE KEY-----
